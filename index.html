<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1e40af">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <title>RegistradurÃ­a Sync Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- LibrerÃ­as para exportar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; font-family: sans-serif; overflow-x: hidden; }
        .input-hc { border: 2px solid #64748b; background-color: #ffffff; color: #000000; font-weight: 800; font-size: 0.95rem; }
        .app-card { background: white; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .gps-active { color: #10b981; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #export-modal { display: none; }
        #export-modal.active { display: flex; }

        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="text-gray-900 min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-blue-800 text-white p-2.5 px-5 shadow-xl rounded-b-2xl sticky top-0 z-50 flex justify-between items-center">
        <div>
            <h1 class="text-base font-black tracking-tight uppercase">Registro <span class="text-blue-300">Sync</span></h1>
            <p id="gps-text" class="text-[7px] font-bold text-blue-200 uppercase leading-none mt-0.5">GPS: Pendiente</p>
        </div>
        <button onclick="initGPS()" class="focus:outline-none active:scale-90 transition-transform">
            <i id="gps-icon" class="fas fa-satellite-dish text-base text-blue-400"></i>
        </button>
    </header>

    <main class="flex-1 p-4 mb-24 overflow-y-auto">
        
        <!-- PESTAÃ‘A FORMULARIO -->
        <section id="tab-form" class="tab-content active">
            <div class="app-card p-5 space-y-3">
                <div class="flex flex-col items-center mb-2">
                    <div class="bg-blue-50 p-4 rounded-2xl border-2 border-blue-100 text-center w-full">
                        <i class="fas fa-file-signature text-blue-600 text-2xl mb-1"></i>
                        <p class="text-[10px] font-black text-blue-800 uppercase">Nuevo Registro de Datos</p>
                    </div>
                </div>

                <div class="space-y-2">
                    <div>
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-1">NÃºmero de CÃ©dula</label>
                        <input type="number" id="cedula" placeholder="Ej: 1067000000" class="input-hc w-full p-2.5 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-1">Nombres</label>
                        <input type="text" id="names" placeholder="NOMBRES" oninput="this.value = this.value.toUpperCase()" class="input-hc w-full p-2.5 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-1">Apellidos</label>
                        <input type="text" id="lastnames" placeholder="APELLIDOS" oninput="this.value = this.value.toUpperCase()" class="input-hc w-full p-2.5 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-gray-500 uppercase ml-1">NÃºmero WhatsApp</label>
                        <input type="number" id="phone" placeholder="3000000000" class="input-hc w-full p-2.5 rounded-lg focus:outline-none focus:border-blue-500">
                    </div>
                </div>

                <button onclick="saveRecord()" id="btn-main-action" class="w-full bg-blue-700 text-white font-black py-3.5 rounded-xl shadow-xl active:scale-95 flex items-center justify-center gap-2 text-sm mt-4 transition-transform">
                    <i class="fas fa-save"></i> GUARDAR REGISTRO
                </button>
            </div>
        </section>

        <!-- PESTAÃ‘A LISTADO -->
        <section id="tab-list" class="tab-content">
            <h2 class="text-xs font-black uppercase text-gray-500 px-1 mb-4">Registros en el dispositivo</h2>
            <div id="list-container" class="space-y-4"></div>
        </section>
    </main>

    <!-- MODAL DE EXPORTACIÃ“N -->
    <div id="export-modal" class="fixed inset-0 bg-black/60 z-[100] items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-[2rem] p-6 shadow-2xl scale-in space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="font-black uppercase text-sm">Exportar Datos</h3>
                <button onclick="toggleExportModal()" class="text-gray-400 p-2"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-[10px] text-gray-500 font-bold uppercase">Selecciona el formato de descarga:</p>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="exportToCSV(); toggleExportModal();" class="bg-emerald-100 text-emerald-700 font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform">
                    <i class="fas fa-file-excel text-xl"></i> EXCEL (CSV)
                </button>
                <button onclick="exportToPDF(); toggleExportModal();" class="bg-red-100 text-red-700 font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform">
                    <i class="fas fa-file-pdf text-xl"></i> REPORTE PDF
                </button>
            </div>
        </div>
    </div>

    <!-- NAVEGACIÃ“N INFERIOR -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-100 p-3 flex justify-around items-center z-50">
        <button onclick="switchTab('form')" id="nav-form" class="flex flex-col items-center text-blue-700 transition-colors">
            <i class="fas fa-user-plus text-xl"></i>
            <span class="text-[9px] font-black mt-1 uppercase">Registro</span>
        </button>
        
        <button onclick="toggleExportModal()" class="flex flex-col items-center text-gray-400 hover:text-blue-600 transition-colors">
            <div class="bg-blue-600 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg -mt-8 border-4 border-white active:scale-90 transition-transform">
                <i class="fas fa-file-export text-lg"></i>
            </div>
            <span class="text-[9px] font-black mt-1 uppercase">Exportar</span>
        </button>

        <button onclick="switchTab('list')" id="nav-list" class="flex flex-col items-center text-gray-400 transition-colors">
            <i class="fas fa-database text-xl"></i>
            <span class="text-[9px] font-black mt-1 uppercase">Base Datos</span>
        </button>
    </nav>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 rounded-full text-[10px] font-bold opacity-0 transition-opacity z-[110] pointer-events-none text-center"></div>

    <script>
        let editId = null;
        let userCoords = null;
        let localDB = JSON.parse(localStorage.getItem('sync_db_v7')) || [];

        function initGPS() {
            if ("geolocation" in navigator) {
                showToast("Buscando seÃ±al GPS...");
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        userCoords = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                        document.getElementById('gps-icon').classList.add('gps-active');
                        document.getElementById('gps-text').innerText = "GPS ACTIVADO";
                        showToast("âœ… GPS LOCALIZADO");
                    },
                    (err) => { 
                        document.getElementById('gps-text').innerText = "GPS NO DISPONIBLE";
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            }
        }
        window.onload = initGPS;

        function toggleExportModal() {
            document.getElementById('export-modal').classList.toggle('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 3000);
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => {
                if(b.id) b.classList.replace('text-blue-700', 'text-gray-400');
            });
            document.getElementById('tab-' + t).classList.add('active');
            const navBtn = document.getElementById('nav-' + t);
            if(navBtn) navBtn.classList.replace('text-gray-400', 'text-blue-700');
            if(t === 'list') renderList();
        }

        function saveRecord() {
            const cc = document.getElementById('cedula').value;
            const nom = document.getElementById('names').value;
            const ape = document.getElementById('lastnames').value;
            const tel = document.getElementById('phone').value;

            if(!cc || !nom || !ape || !tel) return showToast("âš ï¸ POR FAVOR LLENA TODOS LOS CAMPOS");

            const recordData = {
                id: editId || Date.now(),
                cc, nom, ape, tel,
                coords: userCoords,
                date: new Date().toLocaleString()
            };

            if(editId) {
                const index = localDB.findIndex(r => r.id === editId);
                if(index !== -1) localDB[index] = recordData;
                editId = null;
                document.getElementById('btn-main-action').innerHTML = '<i class="fas fa-save"></i> GUARDAR REGISTRO';
                showToast("âœ… REGISTRO ACTUALIZADO");
            } else {
                localDB.push(recordData);
                showToast("ðŸš€ REGISTRO GUARDADO CON Ã‰XITO");
            }

            localStorage.setItem('sync_db_v7', JSON.stringify(localDB));
            clearForm();
        }

        function clearForm() {
            document.getElementById('cedula').value = '';
            document.getElementById('names').value = '';
            document.getElementById('lastnames').value = '';
            document.getElementById('phone').value = '';
            editId = null;
        }

        function renderList() {
            const container = document.getElementById('list-container');
            if(localDB.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-gray-400 font-bold uppercase text-[10px]">Sin registros guardados</div>';
                return;
            }
            container.innerHTML = localDB.slice().reverse().map(r => `
                <div class="app-card p-4 border-2 border-gray-100 relative">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h3 class="text-[12px] font-black text-blue-900 uppercase">${r.nom} ${r.ape}</h3>
                            <p class="text-[14px] font-black text-black">CÃ©dula: ${r.cc}</p>
                        </div>
                        <span class="text-[7px] font-bold text-gray-400 uppercase bg-gray-50 px-2 py-1 rounded-md">${r.date}</span>
                    </div>
                    
                    <div class="flex gap-2 mt-3">
                        <a href="https://wa.me/57${r.tel}" target="_blank" class="bg-emerald-100 text-emerald-700 flex-1 py-2 rounded-lg flex items-center justify-center gap-2 text-xs font-bold shadow-sm">
                            <i class="fab fa-whatsapp"></i> WHATSAPP
                        </a>
                        ${r.coords ? `
                        <a href="https://www.google.com/maps?q=${r.coords.lat},${r.coords.lng}" target="_blank" class="bg-blue-100 text-blue-700 w-10 rounded-lg flex items-center justify-center shadow-sm">
                            <i class="fas fa-map-marker-alt"></i>
                        </a>` : ''}
                        <button onclick="editRecord(${r.id})" class="bg-gray-100 text-gray-700 w-10 rounded-lg flex items-center justify-center shadow-sm">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteRecord(${r.id})" class="bg-red-100 text-red-700 w-10 rounded-lg flex items-center justify-center shadow-sm">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function deleteRecord(id) {
            if(!confirm("Â¿Deseas eliminar este registro de la base de datos?")) return;
            localDB = localDB.filter(r => r.id !== id);
            localStorage.setItem('sync_db_v7', JSON.stringify(localDB));
            renderList();
        }

        function editRecord(id) {
            const r = localDB.find(record => record.id === id);
            if(!r) return;
            document.getElementById('cedula').value = r.cc;
            document.getElementById('names').value = r.nom;
            document.getElementById('lastnames').value = r.ape;
            document.getElementById('phone').value = r.tel;
            editId = id;
            document.getElementById('btn-main-action').innerHTML = '<i class="fas fa-sync"></i> ACTUALIZAR REGISTRO';
            switchTab('form');
        }

        function exportToCSV() {
            if(localDB.length === 0) return showToast("Base de datos vacÃ­a");
            let csv = "\uFEFFFecha,Cedula,Nombres,Apellidos,Telefono,Latitud,Longitud\n";
            localDB.forEach(r => {
                let lat = r.coords ? r.coords.lat : "";
                let lng = r.coords ? r.coords.lng : "";
                csv += `"${r.date}","${r.cc}","${r.nom}","${r.ape}","${r.tel}","${lat}","${lng}"\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `BASE_DATOS_SYNC_${new Date().toLocaleDateString()}.csv`;
            link.click();
            showToast("ðŸ“Š EXCEL GENERADO");
        }

        async function exportToPDF() {
            if(localDB.length === 0) return showToast("Base de datos vacÃ­a");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(16);
            doc.text("REGISTRO SYNC PRO - REPORTE", 14, 20);
            doc.setFontSize(10);
            doc.text(`Total Registros: ${localDB.length} | Fecha: ${new Date().toLocaleString()}`, 14, 28);
            
            const tableData = localDB.map(r => [r.date, r.cc, `${r.nom} ${r.ape}`, r.tel, r.coords ? `${r.coords.lat.toFixed(4)}, ${r.coords.lng.toFixed(4)}` : 'S/G']);
            
            doc.autoTable({ 
                startY: 35, 
                head: [['Fecha', 'CÃ©dula', 'Nombre Completo', 'WhatsApp', 'GPS']], 
                body: tableData, 
                theme: 'grid', 
                headStyles: { fillColor: [30, 64, 175], fontSize: 8 }, 
                styles: { fontSize: 7 }
            });
            doc.save(`REPORTE_PDF_SYNC.pdf`);
            showToast("ðŸ“„ REPORTE PDF LISTO");
        }
    </script>
</body>
</html>