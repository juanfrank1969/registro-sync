<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Sync Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-field { border: 2px solid #cbd5e1; border-radius: 0.75rem; padding: 0.75rem; width: 100%; font-weight: bold; outline: none; transition: border-color 0.2s; font-size: 16px; }
        .input-field:focus { border-color: #1e40af; }
        #export-modal { display: none; }
        #export-modal.active { display: flex; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <!-- Encabezado con estado GPS -->
    <header class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <div>
            <h1 class="text-lg font-black uppercase tracking-tighter">SYNC <span class="text-blue-300">PRO</span></h1>
            <p id="gps-status" class="text-[9px] font-bold text-blue-200 uppercase">GPS: VERIFICANDO...</p>
        </div>
        <i id="gps-icon" class="fas fa-satellite-dish text-blue-400 animate-pulse"></i>
    </header>

    <main class="flex-1 p-4 mb-24">
        
        <!-- PestaÃ±a: Registro de datos -->
        <section id="tab-form" class="tab-content active">
            <div class="bg-white rounded-3xl p-6 shadow-xl space-y-5">
                <div class="text-center border-b pb-3">
                    <h2 class="font-black text-gray-800 uppercase text-sm tracking-widest">Formulario de Registro</h2>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">CÃ©dula de CiudadanÃ­a</label>
                        <input type="number" id="cedula" placeholder="Ej: 1067000..." class="input-field">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">Nombres</label>
                        <input type="text" id="names" placeholder="Nombres" oninput="this.value = this.value.toUpperCase()" class="input-field">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">Apellidos</label>
                        <input type="text" id="lastnames" placeholder="Apellidos" oninput="this.value = this.value.toUpperCase()" class="input-field">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">NÃºmero WhatsApp</label>
                        <input type="number" id="phone" placeholder="3000000000" class="input-field">
                    </div>
                </div>

                <button onclick="saveData()" id="save-btn" class="w-full bg-blue-700 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-save text-lg"></i> GUARDAR REGISTRO
                </button>
            </div>
        </section>

        <!-- PestaÃ±a: VisualizaciÃ³n de Base de Datos -->
        <section id="tab-list" class="tab-content">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest">Base de Datos Local</h2>
                <span id="counter" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black">0 REGISTROS</span>
            </div>
            <div id="list-container" class="space-y-4"></div>
        </section>
    </main>

    <!-- Modal para exportar archivos -->
    <div id="export-modal" class="fixed inset-0 bg-black/80 z-[100] items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl text-center">
            <div class="flex justify-end mb-2">
                <button onclick="toggleModal()" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-circle-xmark text-2xl"></i></button>
            </div>
            
            <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-file-export text-3xl text-blue-600"></i>
            </div>
            
            <h3 class="font-black uppercase text-lg text-gray-800 mb-1">Exportar</h3>
            <p class="text-[10px] text-gray-400 font-bold uppercase mb-6 tracking-tighter">Selecciona el formato de descarga</p>
            
            <div class="space-y-3">
                <button onclick="handleExport('csv')" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i class="fas fa-file-excel"></i> DESCARGAR EXCEL (CSV)
                </button>
                <button onclick="handleExport('pdf')" class="w-full bg-red-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i class="fas fa-file-pdf"></i> DESCARGAR PDF
                </button>
            </div>
            <p class="text-[9px] text-gray-400 mt-4 leading-tight px-2 font-medium">Nota: El archivo se guardarÃ¡ en la carpeta de descargas de tu dispositivo.</p>
        </div>
    </div>

    <!-- NavegaciÃ³n inferior fija -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-3 flex justify-around items-center z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('form')" id="btn-form" class="flex flex-col items-center text-blue-700">
            <i class="fas fa-id-card text-2xl"></i>
            <span class="text-[10px] font-black uppercase mt-1">Registro</span>
        </button>
        
        <button onclick="toggleModal()" class="flex flex-col items-center">
            <div class="bg-blue-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl -mt-12 border-[6px] border-gray-50 active:scale-90 transition-all">
                <i class="fas fa-download text-xl"></i>
            </div>
            <span class="text-[10px] font-black uppercase mt-1 text-gray-400">Exportar</span>
        </button>

        <button onclick="switchTab('list')" id="btn-list" class="flex flex-col items-center text-gray-400">
            <i class="fas fa-server text-2xl"></i>
            <span class="text-[10px] font-black uppercase mt-1">Datos</span>
        </button>
    </nav>

    <!-- Notificaciones flotantes (Toast) -->
    <div id="toast" class="fixed bottom-28 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-8 py-4 rounded-2xl text-[11px] font-black opacity-0 transition-all z-[200] pointer-events-none shadow-2xl border border-gray-700"></div>

    <script>
        // Clave Ãºnica para evitar conflictos de datos
        const STORAGE_KEY = 'SYNC_PRO_REGS_V11';
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let editingId = null;

        // FunciÃ³n de detecciÃ³n GPS bÃ¡sica
        function detectGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    () => {
                        document.getElementById('gps-status').innerText = "GPS: CONECTADO";
                        document.getElementById('gps-icon').className = "fas fa-check-circle text-emerald-500";
                    },
                    () => { 
                        document.getElementById('gps-status').innerText = "GPS: ACTIVAR UBICACIÃ“N";
                        document.getElementById('gps-icon').className = "fas fa-exclamation-triangle text-amber-500 animate-none";
                    }
                );
            }
        }
        window.onload = detectGPS;

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.getElementById('btn-form').className = 'flex flex-col items-center ' + (tabId === 'form' ? 'text-blue-700' : 'text-gray-400');
            document.getElementById('btn-list').className = 'flex flex-col items-center ' + (tabId === 'list' ? 'text-blue-700' : 'text-gray-400');
            
            if(tabId === 'list') renderRecords();
        }

        function toggleModal() {
            document.getElementById('export-modal').classList.toggle('active');
        }

        function saveData() {
            const cc = document.getElementById('cedula').value;
            const names = document.getElementById('names').value;
            const lastnames = document.getElementById('lastnames').value;
            const phone = document.getElementById('phone').value;

            if(!cc || !names || !lastnames || !phone) {
                return showToast("âŒ POR FAVOR LLENA TODOS LOS CAMPOS");
            }

            const record = {
                id: editingId || Date.now(),
                cc, names, lastnames, phone,
                date: new Date().toLocaleString()
            };

            if(editingId) {
                db = db.map(item => item.id === editingId ? record : item);
                editingId = null;
                document.getElementById('save-btn').innerHTML = '<i class="fas fa-save"></i> GUARDAR REGISTRO';
            } else {
                db.push(record);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            showToast("âœ… DATOS GUARDADOS CORRECTAMENTE");
            
            // Limpiar campos
            ['cedula', 'names', 'lastnames', 'phone'].forEach(id => document.getElementById(id).value = '');
        }

        function renderRecords() {
            const container = document.getElementById('list-container');
            document.getElementById('counter').innerText = `${db.length} REGISTROS`;
            
            if(db.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-gray-300 font-black text-[11px] uppercase tracking-widest">Sin registros grabados</div>';
                return;
            }
            
            container.innerHTML = db.slice().reverse().map(item => `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-black text-blue-600 uppercase tracking-tighter">${item.names} ${item.lastnames}</p>
                            <p class="text-base font-black text-gray-800 tracking-tight">CC: ${item.cc}</p>
                        </div>
                        <span class="text-[8px] font-bold text-gray-300 uppercase">${item.date}</span>
                    </div>
                    <div class="flex gap-2">
                        <a href="https://wa.me/57${item.phone}" target="_blank" class="flex-1 bg-emerald-50 text-emerald-700 py-3 rounded-xl text-[10px] font-black flex items-center justify-center gap-2">
                            <i class="fab fa-whatsapp text-sm"></i> WHATSAPP
                        </a>
                        <button onclick="editRecord(${item.id})" class="bg-gray-50 text-gray-500 w-12 rounded-xl flex items-center justify-center border border-gray-100"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteRecord(${item.id})" class="bg-red-50 text-red-500 w-12 rounded-xl flex items-center justify-center border border-red-100"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function editRecord(id) {
            const record = db.find(item => item.id === id);
            document.getElementById('cedula').value = record.cc;
            document.getElementById('names').value = record.names;
            document.getElementById('lastnames').value = record.lastnames;
            document.getElementById('phone').value = record.phone;
            editingId = id;
            document.getElementById('save-btn').innerHTML = '<i class="fas fa-sync"></i> ACTUALIZAR DATOS';
            switchTab('form');
        }

        function deleteRecord(id) {
            if(confirm("Â¿EstÃ¡s seguro de eliminar este registro?")) {
                db = db.filter(item => item.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                renderRecords();
            }
        }

        // --- SISTEMA DE EXPORTACIÃ“N CON ALTA COMPATIBILIDAD (BASE64) ---
        async function handleExport(format) {
            if(db.length === 0) return showToast("No hay datos para exportar");
            toggleModal();
            showToast("â³ Generando archivo...");

            let blob;
            let fileName;

            if(format === 'csv') {
                // Agregar BOM para soporte de tildes en Excel
                let csvContent = "\uFEFFFecha,Cedula,Nombres,Apellidos,Telefono\n";
                db.forEach(r => {
                    csvContent += `"${r.date}","${r.cc}","${r.names}","${r.lastnames}","${r.phone}"\n`;
                });
                blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                fileName = 'Base_Sync_Pro.csv';
            } else {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(16);
                doc.text("REPORTE OFICIAL - SYNC PRO", 14, 15);
                doc.autoTable({
                    head: [['Fecha', 'CÃ©dula', 'Nombre Completo', 'TelÃ©fono']],
                    body: db.map(r => [r.date, r.cc, `${r.names} ${r.lastnames}`, r.phone]),
                    startY: 20,
                    theme: 'grid',
                    headStyles: { fillColor: [30, 64, 175] }
                });
                blob = doc.output('blob');
                fileName = 'Reporte_Sync_Pro.pdf';
            }

            // Transformar a Base64 para saltar restricciones de WebViews en AppsGeyser
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                const downloadLink = document.createElement('a');
                downloadLink.href = base64Data;
                downloadLink.download = fileName;
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
                showToast("ðŸ“¥ Descarga iniciada");
            };
            reader.readAsDataURL(blob);
        }
    </script>
</body>
</html>
