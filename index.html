<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Sync Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .input-field { border: 2px solid #cbd5e1; border-radius: 0.75rem; padding: 0.75rem; width: 100%; font-weight: bold; outline: none; transition: border-color 0.2s; font-size: 16px; }
        .input-field:focus { border-color: #1e40af; }
        #export-modal { display: none; }
        #export-modal.active { display: flex; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-blue-800 text-white p-4 shadow-lg sticky top-0 z-50 flex justify-between items-center">
        <div>
            <h1 class="text-lg font-black uppercase tracking-tighter">SYNC <span class="text-blue-300">PRO</span></h1>
            <p id="gps-status" class="text-[9px] font-bold text-blue-200 uppercase">GPS: VERIFICANDO...</p>
        </div>
        <i id="gps-icon" class="fas fa-satellite-dish text-blue-400 animate-pulse"></i>
    </header>

    <main class="flex-1 p-4 mb-24">
        
        <section id="tab-form" class="tab-content active">
            <div class="bg-white rounded-3xl p-6 shadow-xl space-y-5">
                <div class="text-center border-b pb-3">
                    <h2 class="font-black text-gray-800 uppercase text-sm tracking-widest">Formulario de Registro</h2>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">CÃ©dula de CiudadanÃ­a</label>
                        <input type="number" id="cedula" placeholder="Ej: 1067000..." class="input-field">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">Nombres</label>
                        <input type="text" id="names" placeholder="Nombres" oninput="this.value = this.value.toUpperCase()" class="input-field">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">Apellidos</label>
                        <input type="text" id="lastnames" placeholder="Apellidos" oninput="this.value = this.value.toUpperCase()" class="input-field">
                    </div>
                    <div>
                        <label class="text-[11px] font-black text-blue-900 uppercase ml-1">NÃºmero WhatsApp</label>
                        <input type="number" id="phone" placeholder="3000000000" class="input-field">
                    </div>
                </div>

                <button onclick="saveData()" id="save-btn" class="w-full bg-blue-700 text-white font-black py-4 rounded-2xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-3">
                    <i class="fas fa-save text-lg"></i> GUARDAR REGISTRO
                </button>
            </div>
        </section>

        <section id="tab-list" class="tab-content">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-xs font-black text-gray-500 uppercase tracking-widest">Base de Datos</h2>
                <span id="counter" class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black">0 REGISTROS</span>
            </div>
            <div id="list-container" class="space-y-4"></div>
        </section>
    </main>

    <div id="export-modal" class="fixed inset-0 bg-black/80 z-[100] items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl text-center">
            <div class="flex justify-end mb-2">
                <button onclick="toggleModal()" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-circle-xmark text-2xl"></i></button>
            </div>
            <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-file-export text-3xl text-blue-600"></i>
            </div>
            <h3 class="font-black uppercase text-lg text-gray-800 mb-1">Exportar</h3>
            <p class="text-[10px] text-gray-400 font-bold uppercase mb-6 tracking-tighter">Formatos compatibles con Android</p>
            <div class="space-y-3">
                <button onclick="handleExport('csv')" class="w-full bg-emerald-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i class="fas fa-file-excel"></i> EXCEL (CSV)
                </button>
                <button onclick="handleExport('pdf')" class="w-full bg-red-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-3 flex justify-around items-center z-50 shadow-[0_-10px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('form')" id="btn-form" class="flex flex-col items-center text-blue-700">
            <i class="fas fa-id-card text-2xl"></i>
            <span class="text-[10px] font-black uppercase mt-1">Registro</span>
        </button>
        <button onclick="toggleModal()" class="flex flex-col items-center">
            <div class="bg-blue-700 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-2xl -mt-12 border-[6px] border-gray-50 active:scale-90 transition-all">
                <i class="fas fa-download text-xl"></i>
            </div>
            <span class="text-[10px] font-black uppercase mt-1 text-gray-400">Exportar</span>
        </button>
        <button onclick="switchTab('list')" id="btn-list" class="flex flex-col items-center text-gray-400">
            <i class="fas fa-server text-2xl"></i>
            <span class="text-[10px] font-black uppercase mt-1">Datos</span>
        </button>
    </nav>

    <div id="toast" class="fixed bottom-28 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-8 py-4 rounded-2xl text-[11px] font-black opacity-0 transition-all z-[200] pointer-events-none"></div>

    <script>
        const STORAGE_KEY = 'SYNC_PRO_REGS_V13_FINAL';
        let db = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let editingId = null;

        function detectGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    () => {
                        document.getElementById('gps-status').innerText = "GPS: CONECTADO";
                        document.getElementById('gps-icon').className = "fas fa-check-circle text-emerald-500";
                    },
                    () => { document.getElementById('gps-status').innerText = "GPS: ACTIVAR UBICACIÃ“N"; }
                );
            }
        }
        window.onload = detectGPS;

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.innerText = message;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.getElementById('btn-form').className = 'flex flex-col items-center ' + (tabId === 'form' ? 'text-blue-700' : 'text-gray-400');
            document.getElementById('btn-list').className = 'flex flex-col items-center ' + (tabId === 'list' ? 'text-blue-700' : 'text-gray-400');
            if(tabId === 'list') renderRecords();
        }

        function toggleModal() {
            document.getElementById('export-modal').classList.toggle('active');
        }

        function saveData() {
            const cc = document.getElementById('cedula').value;
            const names = document.getElementById('names').value;
            const lastnames = document.getElementById('lastnames').value;
            const phone = document.getElementById('phone').value;

            if(!cc || !names || !lastnames || !phone) return showToast("âŒ CAMPOS INCOMPLETOS");

            const record = { id: editingId || Date.now(), cc, names, lastnames, phone, date: new Date().toLocaleString() };

            if(editingId) {
                db = db.map(item => item.id === editingId ? record : item);
                editingId = null;
                document.getElementById('save-btn').innerHTML = '<i class="fas fa-save"></i> GUARDAR REGISTRO';
            } else {
                db.push(record);
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
            showToast("âœ… REGISTRO EXITOSO");
            ['cedula', 'names', 'lastnames', 'phone'].forEach(id => document.getElementById(id).value = '');
        }

        function renderRecords() {
            const container = document.getElementById('list-container');
            document.getElementById('counter').innerText = `${db.length} REGISTROS`;
            if(db.length === 0) {
                container.innerHTML = '<div class="text-center py-20 text-gray-300 font-black text-[11px] uppercase tracking-widest">Base de datos vacÃ­a</div>';
                return;
            }
            container.innerHTML = db.slice().reverse().map(item => `
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100 mb-3">
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-tighter">${item.names} ${item.lastnames}</p>
                    <p class="text-base font-black text-gray-800 tracking-tight">CC: ${item.cc}</p>
                    <div class="flex gap-2 mt-3">
                        <button onclick="editRecord(${item.id})" class="bg-gray-100 text-gray-500 flex-1 py-3 rounded-xl"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteRecord(${item.id})" class="bg-red-50 text-red-500 flex-1 py-3 rounded-xl"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `).join('');
        }

        function editRecord(id) {
            const r = db.find(i => i.id === id);
            document.getElementById('cedula').value = r.cc;
            document.getElementById('names').value = r.names;
            document.getElementById('lastnames').value = r.lastnames;
            document.getElementById('phone').value = r.phone;
            editingId = id;
            document.getElementById('save-btn').innerHTML = '<i class="fas fa-sync"></i> ACTUALIZAR';
            switchTab('form');
        }

        function deleteRecord(id) {
            if(confirm("Â¿Eliminar registro?")) {
                db = db.filter(i => i.id !== id);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
                renderRecords();
            }
        }

        // FUNCIÃ“N DE EXPORTACIÃ“N REFORZADA PARA WEB2APP
        async function handleExport(format) {
            if(db.length === 0) return showToast("No hay datos");
            toggleModal();
            showToast("â³ Preparando archivo...");

            let blob;
            let fileName;
            let mimeType;

            if(format === 'csv') {
                let csv = "\uFEFFFecha,Cedula,Nombres,Apellidos,Telefono\n";
                db.forEach(r => csv += `"${r.date}","${r.cc}","${r.names}","${r.lastnames}","${r.phone}"\n`);
                mimeType = 'text/csv';
                blob = new Blob([csv], { type: mimeType });
                fileName = 'Datos_SyncPro.csv';
            } else {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("REGISTRO SYNC PRO - REPORTE", 14, 15);
                doc.autoTable({
                    head: [['Fecha', 'CÃ©dula', 'Nombre', 'WhatsApp']],
                    body: db.map(r => [r.date, r.cc, r.names + ' ' + r.lastnames, r.phone]),
                    startY: 20
                });
                mimeType = 'application/pdf';
                blob = doc.output('blob');
                fileName = 'Reporte_SyncPro.pdf';
            }

            // MÃ‰TODO DE DESCARGA: ConversiÃ³n a Base64 para mÃ¡xima compatibilidad con APKs
            const reader = new FileReader();
            reader.onload = function(e) {
                const dataUrl = e.target.result;
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => document.body.removeChild(a), 150);
                showToast("ðŸ“¥ Guardado en descargas");
            };
            reader.readAsDataURL(blob);
        }
    </script>
</body>
</html>
